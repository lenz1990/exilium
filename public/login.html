<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login – Exilium</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* Fallback, falls styles.css mal nicht greift */
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
    .card { width: min(520px, 100%); padding: 22px; border-radius: 16px; background: rgba(20,22,30,.65); backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 14px; font-size: 28px; }
    label { display:block; margin: 12px 0 6px; opacity: .9; }
    input { width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.06); color: inherit; outline: none; }
    button { margin-top: 14px; padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,.18); background: rgba(120,90,255,.25); color: inherit; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .msg { margin-top: 12px; padding: 10px 12px; border-radius: 10px; display:none; }
    .msg.err { display:block; border: 1px solid rgba(255,80,80,.35); background: rgba(255,80,80,.08); }
    .msg.ok  { display:block; border: 1px solid rgba(80,255,140,.35); background: rgba(80,255,140,.08); }
    .links { margin-top: 14px; display:flex; gap: 12px; opacity: .9; }
    .links a { color: inherit; text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,.35); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Login</h1>

      <form id="loginForm">
        <label for="username">Username</label>
        <input id="username" name="username" autocomplete="username" required />

        <label for="password">Passwort</label>
        <input id="password" name="password" type="password" autocomplete="current-password" required />

        <button id="btn" type="submit">Einloggen</button>
      </form>

      <div id="msg" class="msg"></div>

      <div class="links">
        <a href="/">Start</a>
        <a href="/setup">Setup</a>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("loginForm");
    const btn  = document.getElementById("btn");
    const msg  = document.getElementById("msg");

    function show(type, text) {
      msg.className = "msg " + (type === "ok" ? "ok" : "err");
      msg.textContent = text;
      msg.style.display = "block";
    }

    async function tryMeRedirect() {
      try {
        const r = await fetch("/api/me", { credentials: "include" });
        const j = await r.json().catch(() => null);
        if (r.ok && j && j.ok && j.user) {
          location.href = "/app";
        }
      } catch {}
    }

    tryMeRedirect();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.style.display = "none";

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;

      if (!username || !password) {
        show("err", "Bitte Username und Passwort eingeben.");
        return;
      }

      btn.disabled = true;
      btn.textContent = "…";

      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "content-type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ username, password })
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data || data.ok !== true) {
          // Wenn du hier 405 siehst -> Backend wird nicht getroffen (Routing)
          const hint = res.status === 405
            ? " (Routing-Problem: /api/login läuft nicht über Functions)"
            : "";
          show("err", (data && data.error ? data.error : ("Login fehlgeschlagen (" + res.status + ")")) + hint);
          return;
        }

        show("ok", "Login ok – weiterleiten…");
        setTimeout(() => (location.href = "/app"), 250);
      } catch (err) {
        show("err", "Netzwerkfehler: " + (err && err.message ? err.message : err));
      } finally {
        btn.disabled = false;
        btn.textContent = "Einloggen";
      }
    });
  </script>
</body>
</html>
